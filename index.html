<!DOCTYPE html>
<html lang="is">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tal√¶fing FB - Morgunverk (T√∂lvu√∫tg√°fa)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; background-color: #eef2f5; text-align: center; padding: 10px; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
  
  .card { background: white; width: 100%; max-width: 850px; padding: 20px 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-top: 8px solid #004a99; box-sizing: border-box; }
  
  .overall-progress { margin-bottom: 10px; font-size: 1em; color: #555; text-align: left; }
  .progress-container { width: 100%; background: #e0e0e0; height: 10px; border-radius: 5px; margin-top: 5px; }
  .progress-fill { height: 100%; width: 0%; background: #004a99; border-radius: 5px; transition: width 0.5s ease; }
  
  h2 { color: #2c3e50; margin: 0 0 5px 0; font-size: 1.6em; }
  .counter { color: #888; font-size: 1.1em; margin-bottom: 10px; display: block; font-weight: bold;}
  
  .media-container { width: 100%; height: 280px; background-color: #000; border-radius: 10px; margin-bottom: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
  .exercise-img { width: 100%; height: 100%; object-fit: cover; }
  .video-frame { width: 100%; height: 100%; border: none; }

  .phrase-box { background-color: #f8fbff; border: 2px solid #dce6f1; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
  .target-text { font-size: 1.8em; color: #004a99; font-weight: bold; letter-spacing: 0.5px;}
  
  .controls-wrapper { display: flex; gap: 20px; align-items: stretch; justify-content: space-between; }
  
  .action-area { flex: 1; display: flex; flex-direction: column; justify-content: space-between; gap: 10px; }
  
  .record-btn { background-color: #27ae60; color: white; border: none; padding: 15px; font-size: 1.2em; font-weight: bold; border-radius: 50px; cursor: pointer; transition: 0.2s; width: 100%; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); }
  .record-btn:hover { background-color: #219150; transform: translateY(-2px); }
  .record-btn.recording { background-color: #e74c3c; animation: pulse 1.5s infinite; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3); }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
  
  .nav-row { display: flex; justify-content: space-between; align-items: center; background: #f4f6f8; padding: 8px 12px; border-radius: 10px; }
  .nav-btn { background-color: #fff; border: 1px solid #ccc; padding: 10px 20px; border-radius: 6px; cursor: pointer; color: #555; font-weight: bold; font-size: 1em; transition: 0.2s; }
  .nav-btn:hover { background-color: #eef2f5; border-color: #aaa; }
  .small-logo { height: 35px; width: auto; border-radius: 4px; }

  .result-area { flex: 1; background: #fdfdfe; padding: 15px; border-radius: 10px; border: 1px solid #ddd; display: flex; flex-direction: column; justify-content: center; text-align: left; }
  #accuracy { font-size: 1.1em; margin-bottom: 5px;}
  .score-bar-bg { width: 100%; background: #e0e0e0; height: 12px; border-radius: 6px; overflow: hidden; margin: 5px 0 10px 0; }
  .score-bar-fill { height: 100%; width: 0%; background: #27ae60; transition: width 0.6s ease; }
  
  .user-said { font-size: 1.6em; color: #2c3e50; font-style: italic; font-weight: bold; min-height: 40px; border-left: 5px solid #004a99; padding-left: 10px; margin-top: 10px; display: flex; align-items: center; }
  
  #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
  #cert-wrap { background: white; padding: 40px; border: 10px double #004a99; width: 90%; max-width: 600px; text-align: center; box-sizing: border-box; border-radius: 10px; box-shadow: 0 15px 40px rgba(0,0,0,0.5);}
  .cert-logo { width: 100px; margin-bottom: 10px; }
  .student-name-input { font-size: 1.8em; border: none; border-bottom: 2px solid #004a99; text-align: center; width: 80%; margin: 20px 0; outline: none; background: #f4f4f4; padding: 8px;}
  .action-btns { margin-top: 25px; display: flex; gap: 10px; justify-content: center; }
  .save-btn, .close-btn { border: none; padding: 12px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: 0.2s; }
  .save-btn { background: #004a99; color: white; }
  .save-btn:hover { background: #003366; }
  .close-btn { background: #95a5a6; color: white; }
  .close-btn:hover { background: #7f8c8d; }
</style>
</head>
<body>

<div class="card">
    <div class="overall-progress">
        √Årangur √æinn: <span id="completed-count">0</span> af 10 setningum kl√°ra√∞ar
        <div class="progress-container"><div id="overall-fill" class="progress-fill"></div></div>
    </div>

    <h2>Morgunverk</h2>
    <span class="counter" id="counter">1 / 10</span>

    <div class="media-container" id="media-content">
        </div>

    <div class="phrase-box">
        <span class="target-text" id="target">Hle√∞ inn...</span>
    </div>

    <div class="controls-wrapper">
        <div class="action-area">
            <button class="record-btn" id="record-btn">üéôÔ∏è √ùttu h√©r og lestu</button>
            <div class="nav-row">
                <button class="nav-btn" onclick="move(-1)">‚¨Ö Fyrri</button>
                <img src="https://geymd.arnastofnun.is/ismus/data/e534627e-82ae-497a-8a52-22e8170a9f5a/filename.jpg" alt="FB Logo" class="small-logo">
                <button class="nav-btn" onclick="move(1)">N√¶sta ‚û°</button>
            </div>
        </div>

        <div class="result-area">
            <div id="accuracy" style="font-weight:bold; color:#004a99;">N√°kv√¶mni: 0%</div>
            <div class="score-bar-bg"><div id="score-fill" class="score-bar-fill"></div></div>
            <div style="font-size: 0.9em; color: #888; margin-bottom: 2px;">√û√∫ sag√∞ir:</div>
            <div class="user-said" id="user-input"></div>
        </div>
    </div>
</div>

<div id="modal-overlay">
    <div id="cert-wrap">
        <img src="https://geymd.arnastofnun.is/ismus/data/e534627e-82ae-497a-8a52-22e8170a9f5a/filename.jpg" alt="Logo" class="cert-logo">
        <h1 style="font-family: serif; font-size: 3em; margin: 10px 0; color: #004a99;">SK√çRTEINI</h1>
        <p style="font-size: 1.1em;">√ûetta sta√∞festir a√∞:</p>
        <input type="text" id="student-name" class="student-name-input" placeholder="Skrifa√∞u nafni√∞ √æitt h√©r">
        <p style="font-size: 1.1em;">hefur loki√∞ tal√¶fingunni:</p>
        <h3 style="color: #333; margin: 10px 0; font-size: 1.8em;">Morgunverk</h3>
        <p id="cert-date" style="font-size: 1em; color: #777;"></p>
        <div style="font-size: 2.5em; margin-top: 10px;">üèÜ</div>
    </div>
    <div class="action-btns">
        <button class="save-btn" onclick="downloadCert()">üíæ Vista sem mynd</button>
        <button class="close-btn" onclick="closeModal()">Loka</button>
    </div>
</div>

<script>
// G√∂gnin √æ√≠n - Mj√∂g stuttar setningar √° A1 √ærepi
const exerciseData = [
    // 5 YouTube myndb√∂nd (Einfaldir hlekkir beint √∫r vafra virka n√∫na!)
    { text: "√âg vakna.", url: "https://youtu.be/cF8ljzbOBVc" },
    { text: "√âg fer √° f√¶tur.", url: "https://youtu.be/YSxBkmgtDzI" },
    { text: "√âg fer √≠ sturtu.", url: "https://youtu.be/-uaABQd_FAk" }, 
    { text: "√âg bursta tennur.", url: "https://youtu.be/318GCtqYrRE" }, 
    { text: "√âg grei√∞i h√°r.", url: "https://youtu.be/2w80XQN7juk" }, 

    // 5 Lj√≥smyndir
    { text: "√âg kl√¶√∞i mig.", url: "https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=900&auto=format&fit=crop&q=80" },
    { text: "√âg bor√∞a mat.", url: "https://images.unsplash.com/photo-1493770348161-369560ae357d?w=900&auto=format&fit=crop&q=80" },
    { text: "√âg drekk kaffi.", url: "https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=900&auto=format&fit=crop&q=80" },
    { text: "√âg tek t√∂sku.", url: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=900&auto=format&fit=crop&q=80" },
    { text: "√âg fer √∫t.", url: "https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=900&auto=format&fit=crop&q=80" }
];

let currentIndex = 0;
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = SpeechRecognition ? new SpeechRecognition() : null;

if (recognition) {
    recognition.lang = 'is-IS';
    recognition.continuous = false;
    recognition.interimResults = false;
} else {
    alert("√ûessi vafri sty√∞ur ekki talgreiningu. Nota√∞u Chrome e√∞a Edge √° t√∂lvu.");
}

// √ûETTA ER BREYTINGIN: Hreinsar minni√∞ alltaf √æegar s√≠√∞an er uppf√¶r√∞/refresha√∞!
window.onload = () => { 
    localStorage.clear(); 
    updateUI(); 
    calculateProgress();
};

// N√ùTT FALL: √ötb√Ωr YouTube hlekk me√∞ LOOP!
function getYouTubeEmbedUrl(url) {
    let videoId = "";
    if (url.includes("youtu.be/")) {
        videoId = url.split("youtu.be/")[1].split("?")[0];
    } else if (url.includes("watch?v=")) {
        videoId = url.split("watch?v=")[1].split("&")[0];
    } else if (url.includes("/embed/")) {
        videoId = url.split("/embed/")[1].split("?")[0];
    }
    
    // B√¶tir vi√∞ autoplay, mute, loop, playlist (skilyr√∞i fyrir loop √° youtube) og tekur √∫t takka (controls=0)
    if (videoId) {
        return `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=0`;
    }
    return url;
}

function updateUI() {
    const curr = exerciseData[currentIndex];
    const mediaBox = document.getElementById('media-content');

    document.getElementById('target').innerText = curr.text;
    document.getElementById('counter').innerText = `${currentIndex + 1} / ${exerciseData.length}`;
    
    // K√≠kjum hvort √æetta er Youtube sl√≥√∞ e√∞a mynd
    if (curr.url.includes('youtube.com') || curr.url.includes('youtu.be')) {
        const embedUrl = getYouTubeEmbedUrl(curr.url);
        mediaBox.innerHTML = `<iframe class="video-frame" src="${embedUrl}" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
    } else {
        mediaBox.innerHTML = `<img id="current-image" class="exercise-img" src="${curr.url}" alt="Mynd">`;
    }
    
    // Hle√∞ur inn vistu√∞um ni√∞urst√∂√∞um ef √æ√¶r eru til
    const savedScore = localStorage.getItem('score_' + currentIndex);
    const savedText = localStorage.getItem('text_' + currentIndex);

    if (savedScore !== null) {
        document.getElementById('accuracy').innerText = `N√°kv√¶mni: ${savedScore}%`;
        document.getElementById('score-fill').style.width = savedScore + "%";
    } else {
        document.getElementById('accuracy').innerText = "N√°kv√¶mni: 0%";
        document.getElementById('score-fill').style.width = "0%";
    }

    if (savedText !== null) {
        document.getElementById('user-input').innerText = `‚Äû${savedText}‚Äú`;
    } else {
        document.getElementById('user-input').innerText = "";
    }
}

function calculateProgress() {
    let done = 0;
    for(let i=0; i<exerciseData.length; i++) {
        if((localStorage.getItem('score_'+i) || 0) >= 80) done++;
    }
    document.getElementById('completed-count').innerText = done;
    document.getElementById('overall-fill').style.width = (done/exerciseData.length)*100 + "%";
    
    if(done === exerciseData.length && done > 0) {
        document.getElementById('cert-date').innerText = new Date().toLocaleDateString('is-IS');
        setTimeout(() => {
            document.getElementById('modal-overlay').style.display = 'flex';
        }, 500);
    }
}

function move(dir) {
    currentIndex += dir;
    if(currentIndex < 0) currentIndex = 0;
    if(currentIndex >= exerciseData.length) currentIndex = exerciseData.length - 1;
    updateUI();
}

function formatUserSpeech(text) {
    if (!text) return "";
    let formatted = text.trim();
    formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
    if (!formatted.endsWith('.') && !formatted.endsWith('!')) formatted += ".";
    return formatted;
}

const recBtn = document.getElementById('record-btn');
recBtn.onclick = () => { 
    if (!recognition) return alert("Talgreining ekki studd.");
    try {
        recognition.start(); 
        recBtn.classList.add('recording'); 
        recBtn.innerText = "Hlusta..."; 
    } catch(e) { console.log("Hlj√≥√∞nemi √æegar √≠ gangi e√∞a villa."); }
};

if (recognition) {
    recognition.onresult = (e) => {
        recBtn.classList.remove('recording'); 
        recBtn.innerText = "üéôÔ∏è √ùttu h√©r og lestu";
        
        const rawSpeech = e.results[0][0].transcript;
        const formattedSpeech = formatUserSpeech(rawSpeech);
        const target = exerciseData[currentIndex].text;
        
        const score = compare(rawSpeech, target);
        
        localStorage.setItem('score_' + currentIndex, score);
        localStorage.setItem('text_' + currentIndex, formattedSpeech);
        
        document.getElementById('user-input').innerText = `‚Äû${formattedSpeech}‚Äú`;
        document.getElementById('accuracy').innerText = `N√°kv√¶mni: ${score}%`;
        document.getElementById('score-fill').style.width = score + "%";
        
        calculateProgress(); 
    };

    recognition.onend = () => {
        recBtn.classList.remove('recording');
        recBtn.innerText = "üéôÔ∏è √ùttu h√©r og lestu";
    };
    
    recognition.onerror = (event) => {
        recBtn.classList.remove('recording');
        recBtn.innerText = "üéôÔ∏è √ùttu h√©r og lestu";
        console.error("Talgreiningarvilla:", event.error);
    };
}

function compare(s1, s2) {
    const clean = s => s.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g,"").trim();
    const w1 = clean(s1).split(/\s+/); 
    const w2 = clean(s2).split(/\s+/);
    let m = 0; 
    w1.forEach(w => { if(w2.includes(w)) m++; });
    return Math.round((m / Math.max(w1.length, w2.length)) * 100) || 0;
}

async function downloadCert() {
    const nameInput = document.getElementById('student-name');
    const name = nameInput.value;
    if(!name) return alert("Vinsamlegast skrifa√∞u nafn!");
    
    const wrap = document.getElementById('cert-wrap');
    const nameText = document.createElement('h2');
    nameText.innerText = name;
    nameText.style.color = "#004a99";
    nameText.style.fontSize = "2.2em";
    nameText.style.margin = "15px 0";
    nameInput.style.display = "none";
    nameInput.parentNode.insertBefore(nameText, nameInput);
    
    try {
        const canvas = await html2canvas(wrap, { useCORS: true, scale: 2 });
        const link = document.createElement('a');
        link.download = `Skirteini-${name.replace(/\s+/g, '_')}.png`; 
        link.href = canvas.toDataURL('image/png'); 
        link.click();
    } catch (err) {
        console.error("Villa vi√∞ a√∞ vista sk√≠rteini:", err);
        alert("Gat ekki vista√∞ sk√≠rteini√∞. Athuga√∞u vafrann.");
    } finally {
        nameInput.style.display = "inline-block"; 
        nameText.remove();
    }
}

function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
</script>
</body>
</html>
